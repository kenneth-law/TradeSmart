{% extends 'base.html' %}

{% block title %}TradeSmart Analytics - Day Trading Analysis{% endblock %}

{% block content %}
<div class="home-hero fade-in">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="display-4 mb-3">Advanced Day Trading Analytics</h1>
            <p class="lead mb-4">
                Analyze stocks with powerful algorithms to identify the best day trading opportunities using technical indicators, volatility measures, and sentiment analysis.
            </p>
        </div>
        <div class="col-md-4 text-center text-md-end">
            <i class="fas fa-chart-line fa-5x"></i>
        </div>
    </div>
</div>

{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-search me-2"></i>Stock Analysis</h5>
            </div>
            <div class="card-body">
                <form action="/analyze" method="POST" id="analyzeForm">
                    <div class="mb-4">
                        <label for="tickers" class="form-label">Enter Ticker Symbols</label>
                        <textarea 
                            class="form-control ticker-input" 
                            id="tickers" 
                            name="tickers" 
                            rows="3" 
                            placeholder="Enter comma-separated ticker symbols (e.g., AAPL, MSFT, GOOGL)"
                            required
                        ></textarea>
                        <div class="form-text">For ASX stocks, use the format: APX.AX, WBC.AX</div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn">
                            <i class="fas fa-chart-bar me-2"></i>Analyze Stocks
                        </button>
                    </div>
                </form>
                
                <div id="loadingIndicator" class="text-center mt-4 d-none">
                    <!-- Progress bar -->
                    <div class="progress mb-3" style="height: 20px;">
                        <div id="analysisProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    
                    <!-- Terminal output -->
                    <div class="terminal-container mt-3">
                        <div class="terminal-header">
                            <span>Analysis Log</span>
                        </div>
                        <div id="terminalOutput" class="terminal-body">
                            <div class="terminal-line">Starting analysis...</div>
                        </div>
                    </div>
                    
                    <div class="spinner-container mt-3">
                        <div class="spinner"></div>
                    </div>
                    <p class="mt-3">Analyzing stocks... This may take a few moments.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>About</h5>
            </div>
            <div class="card-body">
                <p>TradeSmart Analytics helps you identify day trading opportunities by analyzing:</p>
                <ul>
                    <li><strong>Technical indicators</strong> - RSI, MACD, Moving Averages</li>
                    <li><strong>Volatility measures</strong> - ATR, Bollinger Bands</li>
                    <li><strong>News sentiment</strong> - Positive/negative market news</li>
                    <li><strong>Gap potential</strong> - Premarket movements</li>
                    <li><strong>Volume activity</strong> - Relative to average</li>
                </ul>
                <p>Each stock receives a comprehensive score indicating its potential as a day trading opportunity.</p>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Quick Tips</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li>Include 5-20 stocks for best comparison results</li>
                    <li>Analyze stocks in the same sector for relative performance</li>
                    <li>Re-run your analysis before market open for fresh data</li>
                    <li>Check news sentiment for potential catalysts</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('analyzeForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission
        
        document.getElementById('analyzeBtn').disabled = true;
        document.getElementById('loadingIndicator').classList.remove('d-none');
        
        // Get ticker symbols
        const tickersInput = document.getElementById('tickers').value;
        const tickers = tickersInput.split(',').map(t => t.trim()).filter(t => t);
        
        if (tickers.length === 0) {
            alert('Please enter at least one ticker symbol');
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('loadingIndicator').classList.add('d-none');
            return;
        }
        
        // Initialize terminal and progress bar
        const terminal = document.getElementById('terminalOutput');
        const progressBar = document.getElementById('analysisProgress');
        
        terminal.innerHTML = '<div class="terminal-line">Starting analysis...</div>';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressBar.setAttribute('aria-valuenow', 0);
        
        // Set up SSE (Server-Sent Events) connection to get real-time updates
        const evtSource = new EventSource(`/analysis_progress?tickers=${encodeURIComponent(tickersInput)}`);
        
        evtSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            // Update progress bar
            if (data.progress !== undefined) {
                const progressValue = data.progress;
                progressBar.style.width = `${progressValue}%`;
                progressBar.textContent = `${progressValue}%`;
                progressBar.setAttribute('aria-valuenow', progressValue);
            }
            
            // Update terminal with log message
            if (data.message) {
                const lineElement = document.createElement('div');
                lineElement.className = 'terminal-line';
                lineElement.textContent = data.message;
                terminal.appendChild(lineElement);
                
                // Scroll to bottom
                terminal.scrollTop = terminal.scrollHeight;
            }
            
            // When analysis is complete, submit the form
            if (data.status === 'complete') {
                evtSource.close();
                document.getElementById('analyzeForm').submit();
            }
            
            // Handle errors
            if (data.error) {
                evtSource.close();
                const lineElement = document.createElement('div');
                lineElement.className = 'terminal-line error-line';
                lineElement.textContent = `ERROR: ${data.error}`;
                terminal.appendChild(lineElement);
                
                // Re-enable button after error
                setTimeout(() => {
                    document.getElementById('analyzeBtn').disabled = false;
                }, 3000);
            }
        };
        
        evtSource.onerror = function() {
            terminal.innerHTML += '<div class="terminal-line error-line">Connection to server lost.</div>';
            evtSource.close();
        };
    });
</script>
{% endblock %}